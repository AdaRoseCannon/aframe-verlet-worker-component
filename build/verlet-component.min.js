!function(t){function e(r){if(n[r])return n[r].exports;var i=n[r]={exports:{},id:r,loaded:!1};return t[r].call(i.exports,i,i.exports,e),i.loaded=!0,i.exports}var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e,n){"use strict";function r(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}function i(t){return function(){var e=t.apply(this,arguments);return new Promise(function(t,n){function r(i,o){try{var s=e[i](o),a=s.value}catch(t){return void n(t)}return s.done?void t(a):Promise.resolve(a).then(function(t){r("next",t)},function(t){r("throw",t)})}return r("next")})}}var o=function(){var t=i(regeneratorRuntime.mark(function t(e){var n;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=new s,t.next=3,n.init(e);case 3:return t.abrupt("return",n);case 4:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}(),s=n(1);AFRAME.registerComponent("verlet-container",{schema:{gravity:{default:-9.8},boxSize:{default:0},floor:{default:-(1/0)}},init:function(){var t=this;this.systemPromise=o(this.data).then(function(e){return t.v=e}),this.systemPromise.then(function(e){return t.el.emit("verlet-container-init-complete",e)}),this.points=new Map,this.updatePoints=this.updatePoints.bind(this)},update:function(){},addPoint:function(t,e){var n=this;return this.systemPromise.then(function(t){return t.addPoint(e)}).then(function(e){return n.points.set(e.point.id,t),e.point.id})},removePoint:function(t){return this.systemPromise.then(function(e){return e.removePoint(t)})},updatePoint:function(t,e){var n={id:t};return Object.assign(n,e),this.systemPromise.then(function(t){return t.updatePoint(n)})},connectPoints:function(t,e,n){return this.systemPromise.then(function(r){return r.connectPoints(t,e,n)})},removeConstraint:function(t){return this.systemPromise.then(function(e){return e.removeConstraint(t)})},tick:function(){this.v&&(this.v.getPoints().then(this.updatePoints),this.v.process())},updatePoints:function(t){for(var e=t.byteData,n=0,r=e.length;n<r;n+=4){var i=e[n+0]&&this.points.get(e[n+0]);if(i){var o=e[n+1],s=e[n+2],a=e[n+3];i.setPosition(o,s,a)}}}}),AFRAME.registerComponent("verlet-constraint",{schema:{stiffness:{default:.05},from:{type:"selectorAll"},to:{type:"selectorAll"},distance:{default:""}},init:function(){for(var t=this.el;t&&t.matches&&!t.matches("[verlet-container]");)t=t.parentNode;t.components["verlet-container"]?this.parentReadyPromise=Promise.resolve(t.components["verlet-container"]):this.parentReadyPromise=new Promise(function(e){return t.addEventListener("verlet-container-init-complete",function(){return e(t.components["verlet-container"])})}),this.constraints=new Map},update:function(){var t=this;this.remove().then(function(){t.idPromises=t.idPromises||[],t.data.restingDistance=t.data.distance?Number(t.data.distance):void 0,t.parentReadyPromise.then(function(e){t.data.from&&t.data.from.length||(t.el.matches("[verlet-point]")?t.data.from=[t.el]:t.data.from=[]),t.data.to&&t.data.to.length||(t.el.matches("[verlet-point]")?t.data.to=[t.el]:t.data.to=[]);var n=!0,r=!1,i=void 0;try{for(var o,s=t.data.to[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var a=o.value,u=!0,c=!1,d=void 0;try{for(var f,l=t.data.from[Symbol.iterator]();!(u=(f=l.next()).done);u=!0){var h=f.value;a!==h&&(a.components["verlet-point"].idPromise||a.updateComponent("verlet-point"),h.components["verlet-point"].idPromise||h.updateComponent("verlet-point"),t.idPromises.push(Promise.all([a.components["verlet-point"].idPromise,h.components["verlet-point"].idPromise]).then(function(n){var r=n[0],i=n[1];return e.connectPoints(r,i,{stiffness:t.data.stiffness,restingDistance:t.data.restingDistance}).then(function(t){return t.constraintId})})))}}catch(t){c=!0,d=t}finally{try{!u&&l.return&&l.return()}finally{if(c)throw d}}}}catch(t){r=!0,i=t}finally{try{!n&&s.return&&s.return()}finally{if(r)throw i}}})})},remove:function(){return this.idPromises?Promise.all([this.parentReadyPromise].concat(r(this.idPromises))).then(function(t){var e=t.shift();return Promise.all(t.map(function(t){return e.removeConstraint(t)}))}):Promise.resolve()}}),AFRAME.registerComponent("verlet-point",{schema:{position:{type:"vec3"},velocity:{type:"vec3"},mass:{default:1},radius:{default:0}},init:function(){for(var t=this,e=this.el;e&&e.matches&&!e.matches("[verlet-container]");)e=e.parentNode;e.components["verlet-container"]?this.parentReadyPromise=Promise.resolve(e.components["verlet-container"]):this.parentReadyPromise=new Promise(function(t){return e.addEventListener("verlet-container-init-complete",function(){return t(e.components["verlet-container"])})}),this.parentReadyPromise.then(function(e){t.parentVerletComponent=e}),this.el.updateComponent("position")},setPosition:function(t,e,n){this.el.object3D.position.x=t,this.el.object3D.position.y=e,this.el.object3D.position.z=n},update:function(){var t=this;return this.parentReadyPromise.then(function(e){return t.data.position=t.attrValue.position?t.data.position:t.el.object3D.position,t.idPromise?t.idPromise.then(function(n){return e.updatePoint(n,t.data)}):(t.idPromise=e.addPoint(t,t.data),t.idPromise)})},remove:function(){var t=this;return this.parentReadyPromise.then(function(e){return t.idPromise?t.idPromise.then(function(t){return e.removePoint(t)}):Promise.resolve()})}}),AFRAME.registerPrimitive("a-verlet-constraint",{defaultComponents:{"verlet-constraint":{}},mappings:{to:"verlet-constraint.to",from:"verlet-constraint.from",stiffness:"verlet-constraint.stiffness",distance:"verlet-constraint.distance"}})},function(t,e){"use strict";function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function r(t){var e=this,n=t.data;return"handshake"===n.id?void this.workerPromiseResolver():void n.forEach(function(t){var n=o.get(t.id);o.delete(t.id),delete t.id,t.error?n.reject(t.error):(t.byteData&&(e.dataAvailable=!0,e.data=new Float32Array(t.byteData),t.byteData=e.data),n.resolve(t))})}var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),o=new Map,s="BYTE_DATA_STAND_IN",a=function(){function t(){var e=this,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10;n(this,t),this.myWorker=new Worker("./build/worker.js"),this.workerPromise=new Promise(function(t){return e.workerPromiseResolver=t}),this.myWorker.addEventListener("message",r.bind(this)),this.messageQueue=[],this.setMaxPoints(i),this.process=this.process.bind(this)}return i(t,[{key:"setMaxPoints",value:function(t){this.maxPoints=t,this.data=new Float32Array(4*t),this.dataAvailable=!0}},{key:"process",value:function(){if(this.data&&this.messageQueue.length){var t=[],e={},n=this.messageQueue.splice(0),r=!0,i=!1,s=void 0;try{for(var a,u=n[Symbol.iterator]();!(r=(a=u.next()).done);r=!0){var c=a.value;c.message.BYTE_DATA_STAND_IN&&(delete c.message.BYTE_DATA_STAND_IN,c.message.byteData=this.data.buffer,t.indexOf(this.data.buffer)===-1&&t.push(this.data.buffer)),e[c.id]=c.message,o.set(c.id,c)}}catch(t){i=!0,s=t}finally{try{!r&&u.return&&u.return()}finally{if(i)throw s}}t.indexOf(this.data.buffer)!==-1&&(this.dataAvailable=!1,this.data=void 0),this.myWorker.postMessage(e,t)}}},{key:"workerMessage",value:function(t){var e=String(Date.now()+Math.floor(1e6*Math.random()));return new Promise(function(n,r){var i={id:e,message:t,resolve:n,reject:r};if("getPoints"===t.action){var o=!0,s=!1,a=void 0;try{for(var u,c=this.messageQueue[Symbol.iterator]();!(o=(u=c.next()).done);o=!0){var d=u.value;"getPoints"===d.message.action&&(d.message.action="noopPoints")}}catch(t){s=!0,a=t}finally{try{!o&&c.return&&c.return()}finally{if(s)throw a}}}this.messageQueue.push(i)}.bind(this))}},{key:"init",value:function(t){var e=this;return this.workerPromise.then(function(){var n=e.workerMessage({action:"init",options:t});return e.process(),n})}},{key:"getPoints",value:function(){return this.workerMessage({action:"getPoints",BYTE_DATA_STAND_IN:s})}},{key:"addPoint",value:function(t){return this.workerMessage({action:"addPoint",pointOptions:t})}},{key:"updatePoint",value:function(t){return this.workerMessage({action:"updatePoint",pointOptions:t})}},{key:"removePoint",value:function(t){return this.workerMessage({action:"removePoint",options:{id:t}})}},{key:"connectPoints",value:function(t,e,n){return this.workerMessage({action:"connectPoints",options:{id1:t,id2:e,constraintOptions:n}})}},{key:"updateConstraint",value:function(t){return this.workerMessage({action:"updateConstraint",options:t})}},{key:"removeConstraint",value:function(t){return this.workerMessage({action:"removeConstraint",options:{constraintId:t}})}},{key:"reset",value:function(){return this.workerMessage({action:"reset"})}}]),t}();t.exports=a}]);